[include fluidd.cfg]
[include macros/macros.cfg]
[mcu]
serial: /dev/serial/by-id/usb-Klipper_lpc1769_03D00007A39869AF1841405EC72000F5-if00

[printer]
kinematics: cartesian
max_velocity: 150
max_accel: 2500
max_accel_to_decel: 1200
max_z_velocity: 20
max_z_accel: 100

[stepper_x]
step_pin: P2.2
dir_pin: P2.6
enable_pin: !P2.1
#endstop_pin: P1.29
endstop_pin: tmc2209_stepper_x:virtual_endstop
homing_retract_dist: 0
microsteps: 16
rotation_distance: 40
position_min: 0 #-1.2                                                              # home offset, measure yours or disable for no offset
position_endstop: 0 #-1.2                                                          # home offset, measure yours or set '0' for no offset
position_max: 255
homing_speed: 50
second_homing_speed: 8

[tmc2209 stepper_x]
uart_pin: P1.10
diag_pin: P1.29
#run_current: 1.4
#hold_current: 0.950
run_current: 1.3
hold_current: 1
stealthchop_threshold: 999999
stealthchop_threshold: 1
driver_SGTHRS: 100


[stepper_y]
step_pin: P0.19
dir_pin: P0.20
enable_pin: !P2.8
endstop_pin: tmc2209_stepper_y:virtual_endstop
microsteps: 16
rotation_distance: 40
position_min: -4.8                                                            # home offset, measure yours or disable for no offset
position_endstop: -4.8
position_max: 200
homing_speed: 50
second_homing_speed: 8
homing_retract_dist: 0

[tmc2209 stepper_y]
uart_pin: P1.9
diag_pin: P1.28
#run_current: 1.4
#hold_current: 0.950
stealthchop_threshold: 999999
run_current: 1.2
hold_current: 1
driver_SGTHRS: 100

[stepper_z]
step_pin: P0.22
dir_pin: !P2.11
enable_pin: !P0.21
endstop_pin: probe:z_virtual_endstop #~P1.27
microsteps: 16
rotation_distance: 8
position_min: -5
position_max: 200
homing_speed: 5
#homing_retract_speed: 2
##homing_retract_dist: 1
#second_homing_speed: 0.5

[tmc2209 stepper_z]
uart_pin: P1.8
#run_current: 0.650
#hold_current: 0.450
#stealthchop_threshold: 500
run_current: 0.650
hold_current: 0.460
stealthchop_threshold: 999999

[heater_bed]
heater_pin: P2.5
sensor_pin: P0.25
sensor_type: EPCOS 100K B57560G104F
min_temp: 0
max_temp: 130
#control = pid
#pid_kp = 63.125
#pid_ki = 1.163
#pid_kd = 856.929

[extruder]
step_pin: P2.13
dir_pin: P0.11
enable_pin: !P2.12
full_steps_per_rotation: 400
rotation_distance: 9.142
microsteps: 16
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 9999999                                          # ~100 direct, ~600 bowden
heater_pin: P2.7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: P0.24
min_temp: 0
max_temp: 310
pressure_advance = 0
control = pid
pid_kp = 33.964
pid_ki = 2.866
pid_kd = 100.619

[tmc2209 extruder]
uart_pin: P1.4
run_current: 0.35
hold_current: 0.2
stealthchop_threshold: 0
sense_resistor: 0.110

[heater_fan extruder_fan]
pin: P2.4
heater_temp: 50.0

[fan]
pin: P2.3
kick_start_time: 0.500

[bed_screws]
screw1: 25,30
screw1_name: front left screw
screw2: 230,30
screw2_name: front right screw
screw3: 230,180
screw3_name: back right screw
screw4: 25,180
screw4_name: back left screw
speed: 150

[bed_screws]
screw5: 127.5,105
screw5_name: center virtual screw

[screws_tilt_adjust]                                                            # = nozzle_xy = probe_xy - offset_xy
screw1: 23,92.5
screw1_name: front left screw
screw2: 230,92.5
screw2_name: front right screw
screw3: 230,200
screw3_name: back right screw
screw4: 23,200
screw4_name: back left screw
speed: 100
horizontal_move_z: 10
screw_thread: CW-M4

[firmware_retraction]
retract_speed: 30
unretract_speed: 30

[output_pin _BEEPER_pin]
pin: P1.18
pwm: True
value: 0
shutdown_value: 0
cycle_time: 0.0024

[bed_mesh]
speed: 100
horizontal_move_z: 10
mesh_min: 22,20                                                                   # CAUTION! = probe_xy = nozzle_xy + offset_xy
mesh_max: 255,150                                                               # CAUTION! = probe_xy = nozzle_xy + offset_xy
probe_count: 6,6
mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.2
relative_reference_index: 18                                                    # center point


[safe_z_home]
#home_xy_position: 106.4,161
home_xy_position: 105.5,150
z_hop: 10                 # Move up 5
z_hop_speed: 20
speed: 200

[bltouch]
sensor_pin: ^P0.10 #Probe
control_pin: P2.0 #SERVOS
samples: 3
x_offset: 22
y_offset: -50

[input_shaper]


[respond]

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


[gcode_macro HIGH_SPEED]
gcode:
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.000 HOLDCURRENT=0.750
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.000 HOLDCURRENT=0.750
    #SET_TMC_CURRENT STEPPER=extruder CURRENT=0.600 HOLDCURRENT=0.300
    
[gcode_macro NORMAL_SPEED]
gcode:
    {% set tmc_x = printer.configfile.settings["tmc2209 stepper_x"] %}
    {% set tmc_y = printer.configfile.settings["tmc2209 stepper_y"] %}
    {% set tmc_e = printer.configfile.settings["tmc2209 extruder"] %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={tmc_x.run_current} HOLDCURRENT={tmc_x.hold_current}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={tmc_y.run_current} HOLDCURRENT={tmc_y.hold_current}
    #SET_TMC_CURRENT STEPPER=extruder CURRENT={tmc_e.run_current} HOLDCURRENT={tmc_e.hold_current}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 50.145
#*# pid_ki = 1.827
#*# pid_kd = 344.122
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.385000, -0.263333, -0.145833, -0.074167, -0.070000, -0.091667, -0.190833
#*# 	  -0.345833, -0.246667, -0.134167, -0.078333, -0.039167, -0.037500, -0.067500
#*# 	  -0.297500, -0.192500, -0.090833, -0.004167, 0.000000, 0.060000, 0.025833
#*# 	  -0.301667, -0.191667, -0.087500, -0.032500, -0.011667, 0.028333, 0.042500
#*# 	  -0.308333, -0.221667, -0.144167, -0.055000, -0.034167, 0.053333, 0.116667
#*# x_count = 7
#*# y_count = 5
#*# mesh_x_pps = 3
#*# mesh_y_pps = 3
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 22.0
#*# max_x = 254.97
#*# min_y = 20.0
#*# max_y = 150.0
#*#
#*# [bltouch]
#*# z_offset = 1.046
